<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .main-content { padding: 30px; }
        .section { margin-bottom: 40px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background: #f8f9fa; }
        .section h3 { margin-bottom: 20px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px; margin-bottom: 10px; transition: all 0.3s ease; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-success { background: #2ecc71; color: white; }
        .btn-success:hover { background: #27ae60; transform: translateY(-2px); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; transform: translateY(-2px); }
        .btn-secondary { background: #95a5a6; color: white; }
        .members-list { border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; background: white; }
        .member-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .member-item:last-child { border-bottom: none; }
        .member-name { font-weight: bold; color: #2c3e50; }
        .member-contact { color: #7f8c8d; font-size: 12px; }
        .remove-member { color: #e74c3c; cursor: pointer; font-weight: bold; padding: 5px; }
        .status-panel { display: none; background: #ecf0f1; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .voting-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-card { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; }
        .info-title { font-size: 12px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px; }
        .info-value { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .votes-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0; }
        .vote-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .vote-card.for { border-top: 4px solid #2ecc71; }
        .vote-card.against { border-top: 4px solid #e74c3c; }
        .vote-card.abstain { border-top: 4px solid #f39c12; }
        .vote-count { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .vote-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; }
        .timer-display { font-size: 24px; font-weight: bold; text-align: center; padding: 15px; background: #e74c3c; color: white; border-radius: 8px; margin: 20px 0; }
        .tokens-list { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .token-item { margin-bottom: 10px; padding: 10px; background: #34495e; border-radius: 4px; word-break: break-all; }
        .token-member { color: #3498db; font-weight: bold; }
        .token-url { color: #2ecc71; margin-top: 5px; }
        .copy-btn { background: #3498db; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-left: 10px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-active { background: #2ecc71; }
        .status-inactive { background: #95a5a6; }
        .status-completed { background: #f39c12; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .voting-info { grid-template-columns: 1fr; }
            .votes-display { grid-template-columns: 1fr; }
            .container { margin: 10px; border-radius: 10px; }
            .main-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Панель администратора</h1>
            <p>Система анонимного голосования для защиты</p>
        </div>

        <div class="main-content">
            <div id="alerts"></div>

            <!-- Создание сессии -->
            <div class="section" id="create-session-section">
                <h3>Создание новой сессии голосования</h3>

                <form id="session-form">
                    <div class="form-group">
                        <label for="session-title">Название сессии защиты:</label>
                        <input type="text" id="session-title" required placeholder="Например: Защита диссертаций - январь 2025">
                    </div>

                    <div class="form-group">
                        <label for="session-description">Описание:</label>
                        <textarea id="session-description" rows="3" placeholder="Краткое описание сессии защиты"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Члены комиссии:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="member-name" placeholder="ФИО члена комиссии">
                            <input type="text" id="member-contact" placeholder="Email или телефон">
                            <button type="button" class="btn btn-secondary" onclick="addMember()">Добавить</button>
                        </div>
                        <div class="members-list" id="members-list"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">Создать сессию</button>
                </form>
            </div>

            <!-- Управление голосованием -->
            <div class="section hidden" id="voting-control-section">
                <h3>Управление голосованием</h3>

                <div class="voting-info">
                    <div class="info-card">
                        <div class="info-title">ID сессии</div>
                        <div class="info-value" id="current-session-id">-</div>
                    </div>
                    <div class="info-card">
                        <div class="info-title">Статус</div>
                        <div class="info-value">
                            <span class="status-indicator status-inactive"></span>
                            <span id="session-status">Готово к запуску</span>
                        </div>
                    </div>
                </div>

                <form id="voting-form">
                    <div class="form-group">
                        <label for="presenter-name">ФИО докладчика:</label>
                        <input type="text" id="presenter-name" required placeholder="Иванов Иван Иванович">
                    </div>

                    <div class="form-group">
                        <label for="topic-title">Тема доклада:</label>
                        <input type="text" id="topic-title" required placeholder="Название диссертации/проекта">
                    </div>

                    <div class="form-group">
                        <label for="topic-description">Краткое описание:</label>
                        <textarea id="topic-description" rows="3" placeholder="Краткая аннотация работы"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="duration">Время голосования (минут):</label>
                        <input type="number" id="duration" value="5" min="1" max="30" required>
                    </div>

                    <button type="submit" class="btn btn-success" id="start-voting-btn">Запустить голосование</button>
                    <button type="button" class="btn btn-danger hidden" id="end-voting-btn" onclick="endVoting()">Завершить досрочно</button>
                </form>
            </div>

            <!-- Статус голосования -->
            <div class="status-panel" id="status-panel">
                <h4>Текущее голосование</h4>

                <div class="timer-display" id="timer-display">
                    Ожидание запуска...
                </div>

                <div class="votes-display">
                    <div class="vote-card for">
                        <div class="vote-count" id="votes-for">0</div>
                        <div class="vote-label">За</div>
                    </div>
                    <div class="vote-card against">
                        <div class="vote-count" id="votes-against">0</div>
                        <div class="vote-label">Против</div>
                    </div>
                    <div class="vote-card abstain">
                        <div class="vote-count" id="votes-abstain">0</div>
                        <div class="vote-label">Воздержался</div>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-title">Проголосовало из общего числа</div>
                    <div class="info-value"><span id="voted-count">0</span> / <span id="total-members">0</span></div>
                </div>
            </div>

            <!-- Токены для голосования -->
            <div class="section hidden" id="tokens-section">
                <h3>Токены для голосования</h3>
                <p style="margin-bottom: 15px;">Отправьте каждому члену комиссии его персональную ссылку для голосования:</p>
                <div class="tokens-list" id="tokens-list"></div>
                <button type="button" class="btn btn-secondary" onclick="copyAllTokens()">Скопировать все ссылки</button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let members = [];
        let votingTimer = null;
        let websocket = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            websocket = new WebSocket(`${protocol}//${window.location.host}/ws/admin`);

            websocket.onopen = function() {
                console.log('WebSocket соединение установлено');
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            websocket.onclose = function() {
                console.log('WebSocket соединение закрыто');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'voting_started':
                    updateVotingStatus('active');
                    showAlert('Голосование запущено!', 'success');
                    break;
                case 'vote_received':
                    updateVotesCounts(data.current_votes);
                    updateVotedCount(Object.values(data.current_votes).reduce((a, b) => a + b, 0), data.total_members);
                    break;
                case 'voting_ended':
                    updateVotingStatus('completed');
                    updateVotesCounts(data.results);
                    showAlert(`Голосование завершено! Результаты: За: ${data.results.за}, Против: ${data.results.против}, Воздержались: ${data.results.воздержался}`, 'info');
                    break;
            }
        }

        window.onload = function() {
            connectWebSocket();
        };

        function addMember() {
            const name = document.getElementById('member-name').value.trim();
            const contact = document.getElementById('member-contact').value.trim();

            if (!name || !contact) {
                showAlert('Заполните имя и контакт члена комиссии', 'error');
                return;
            }

            members.push({name, contact});
            updateMembersList();

            document.getElementById('member-name').value = '';
            document.getElementById('member-contact').value = '';
        }

        function removeMember(index) {
            members.splice(index, 1);
            updateMembersList();
        }

        function updateMembersList() {
            const container = document.getElementById('members-list');
            container.innerHTML = '';

            members.forEach((member, index) => {
                const item = document.createElement('div');
                item.className = 'member-item';
                item.innerHTML = `
                    <div class="member-info">
                        <div class="member-name">${member.name}</div>
                        <div class="member-contact">${member.contact}</div>
                    </div>
                    <span class="remove-member" onclick="removeMember(${index})">✕</span>
                `;
                container.appendChild(item);
            });
        }

        document.getElementById('session-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (members.length === 0) {
                showAlert('Добавьте хотя бы одного члена комиссии', 'error');
                return;
            }

            const sessionData = {
                title: document.getElementById('session-title').value,
                description: document.getElementById('session-description').value,
                members: members
            };

            try {
                const response = await fetch('/api/admin/create-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(sessionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    currentSessionId = result.session_id;

                    document.getElementById('current-session-id').textContent = currentSessionId;
                    document.getElementById('create-session-section').classList.add('hidden');
                    document.getElementById('voting-control-section').classList.remove('hidden');
                    document.getElementById('status-panel').style.display = 'block';
                    document.getElementById('total-members').textContent = members.length;

                    showAlert('Сессия успешно создана!', 'success');
                } else {
                    const error = await response.json();
                    showAlert('Ошибка: ' + error.detail, 'error');
                }
            } catch (error) {
                showAlert('Ошибка соединения: ' + error.message, 'error');
            }
        });

        document.getElementById('voting-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const votingData = {
                presenter_name: document.getElementById('presenter-name').value,
                topic_title: document.getElementById('topic-title').value,
                topic_description: document.getElementById('topic-description').value,
                duration_minutes: parseInt(document.getElementById('duration').value)
            };

            try {
                const response = await fetch(`/api/admin/start-voting/${currentSessionId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(votingData)
                });

                if (response.ok) {
                    const result = await response.json();
                    displayTokens(result.tokens);
                    startTimer(votingData.duration_minutes * 60);

                    document.getElementById('start-voting-btn').classList.add('hidden');
                    document.getElementById('end-voting-btn').classList.remove('hidden');
                    document.getElementById('tokens-section').classList.remove('hidden');

                } else {
                    const error = await response.json();
                    showAlert('Ошибка: ' + error.detail, 'error');
                }
            } catch (error) {
                showAlert('Ошибка соединения: ' + error.message, 'error');
            }
        });

        function displayTokens(tokens) {
            const container = document.getElementById('tokens-list');
            container.innerHTML = '';

            tokens.forEach(token => {
                const item = document.createElement('div');
                item.className = 'token-item';
                item.innerHTML = `
                    <div class="token-member">${token.member}</div>
                    <div>Контакт: ${token.contact}</div>
                    <div class="token-url">${token.voting_url}</div>
                    <button class="copy-btn" onclick="copyToClipboard('${token.voting_url}')">Копировать</button>
                `;
                container.appendChild(item);
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Ссылка скопирована в буфер обмена', 'success');
            });
        }

        function copyAllTokens() {
            const tokens = document.querySelectorAll('.token-url');
            const allTokens = Array.from(tokens).map(el => el.textContent).join('\n');
            copyToClipboard(allTokens);
        }

        function startTimer(seconds) {
            const display = document.getElementById('timer-display');
            let remaining = seconds;

            votingTimer = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `Время голосования: ${minutes}:${secs.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(votingTimer);
                    display.textContent = 'Голосование завершено';
                    display.style.background = '#95a5a6';
                }
                remaining--;
            }, 1000);
        }

        async function endVoting() {
            if (!confirm('Вы уверены, что хотите досрочно завершить голосование?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/end-voting/${currentSessionId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    clearInterval(votingTimer);
                    updateVotingStatus('completed');
                    updateVotesCounts(result.results);
                } else {
                    const error = await response.json();
                    showAlert('Ошибка: ' + error.detail, 'error');
                }
            } catch (error) {
                showAlert('Ошибка соединения: ' + error.message, 'error');
            }
        }

        function updateVotingStatus(status) {
            const statusElement = document.getElementById('session-status');
            const indicator = document.querySelector('.status-indicator');

            switch(status) {
                case 'active':
                    statusElement.textContent = 'Голосование активно';
                    indicator.className = 'status-indicator status-active';
                    break;
                case 'completed':
                    statusElement.textContent = 'Голосование завершено';
                    indicator.className = 'status-indicator status-completed';
                    document.getElementById('end-voting-btn').classList.add('hidden');
                    break;
            }
        }

        function updateVotesCounts(votes) {
            document.getElementById('votes-for').textContent = votes.за || 0;
            document.getElementById('votes-against').textContent = votes.против || 0;
            document.getElementById('votes-abstain').textContent = votes.воздержался || 0;
        }

        function updateVotedCount(voted, total) {
            document.getElementById('voted-count').textContent = voted;
            document.getElementById('total-members').textContent = total;
        }

        function showAlert(message, type) {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            alerts.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
